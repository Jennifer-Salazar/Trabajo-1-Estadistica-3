---
title: "Borrador"
author: "Jennifer Salazar"
output: powerpoint_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Falta hacer esto

Defina la variable de la serie, su unidad de medida, su construcci√≥n e interpretacion de sus cifras, per¬¥ƒ±odos observados, frecuencia de observaci¬¥on, total de observaciones y fuente de los datos.



# Librerias utiles

```{r}
library(forecast)
library(TSA)
library(fANCOVA)
```



```{r}
Datos20
```


# 2. Analisis descriptivo de la serie y modelos propuestos:



```{r}
plot(Datos20)
```



## Descomposici√≥n aditiva (tendencia)

* La serie es de componentes aditivas dado que su varianza es constante alrededor de su trayectoria de largo plazo(tendencia).


```{r}
Tt=decompose(Datos20)$trend
plot(Tt,ylim=c(min(Datos20),max(Datos20)))
```

* es visible que la serie es de tendencia creciente y que existen ciclos.


##  grafico de boxplots comparativos de la distribucion de la serie versus perƒ±odos del a√±o calendario


```{r}
boxplot(Datos20~cycle(Datos20), names=month.abb)
grid()
```

* vemos c√≥mo la media en particular la mediana de la distribuci√≥n de la serie seg√∫n periodo del a√±o, cambia a lo largo de un a√±o calendario siendo menor en los meses de enero, febrero, abril y diciembre comparados con el resto del a√±o. Tiene un crecimiento de enero a marzo y luego vuelve y baja en abril  para volver a subir en mayo manteniendose relativamente al mismo nivel en los siguientes meses hasta noviembre, para luego decaer en diciembre y retormar el siguiente a√±o.


## Periodograma


```{r}
periodogram(diff(Datos20),lwd=4) #periodograma sobre los logaritmos diferenciados
abline(v=c(1:6)/12,col=2,lty=2)
grid()
```


el periodograma muestra la asociacion de la serie con cuatro componentes periodicas (por valor alto del periodograma en esas frecuencias): en las frecuencias 1/12 y 2/12, 3/12, 4/12.


# justifique por que existe componente estacional y si su forma es constante o no en el tiempo. 

- Mediante el gr√°fico de la serie vs el tiempo se ve un patr√≥n que se repite cada a√±o; pues en cada a√±o se observa que en los meses del inicio y del final el √≠ndice de producci√≥n nominal es bajo y tiene aproximadamente 2 picos de decaimiento en el transcurso del a√±o.

- Dado que en el gr√°fico de boxplot al menos una de las medias de los meses cambia respecto al resto de los meses del a√±o calendario, por lo tanto se concluye que cada periodo en que se divide el a√±o calendario determina una estaci√≥n, la cual tiene incidencia sobre el valor medio de la serie, por ellos se dice que existe la componente estacional.

- Mediante el periodograma se resalta que hay una asociaci√≥n de la serie con fenomenos periodicos, indicando la existencia de una componente estacional.


## Es la estacionalidad constante o no en el tiempo:

```{r}
par(mfrow=c(2,2))
plot(Datos20, xlim=c(2001,2005))
plot(Datos20, xlim=c(2006,2010))
plot(Datos20, xlim=c(2011,2015))
plot(Datos20, xlim=c(2016,2019))

```

Estamos en desacuerdo, lo respondemos m√°s tarde.

## la tendencia se puede ajustar globalmente o si es local.

- La tendencia de la serie es global ya que se puede ajustar una curva suave creciente en todos los tiempos de la serie, Tambi√©n se puede ajustar modelos locales para comparar los ajustes y pronosticos respecto a la ajuste global.



##  identificacion de posibles ciclos y cambios estructurales.

* Hay presencia de ciclos en la serie a tr√°ves del tiempo ya que al aplicar la descomposici√≥n aditiva y obtener la tendencia, no se observa una curva suave que describa la tendencia de la serie.
* Hay aproximadamente entre 4 y 5 ciclos en la serie a trav√©s del tiempo (monta√±as).
* No hay presencia de cambios estructurales en la serie.




#################################################################################


# Modelos propuestos




Por el an√°lisis descriptivo, para los modelos globales la tendencia en escala logaritmo natural puede ser ajustada por un polinomio de grado $p = 2, 3$ y la componente estacional puede representarse como un factor y por tanto usar
variables indicadoras en los modelos globales. Se proponen los siguientes modelos de regresi√≥n, donde t es el √≠ndice de tiempo y $I_{i,t}$ es la indicadora del trimestre i en el tiempo t.


## Modelo 1: Modelo cuadr√°tico estacional con indicadoras, mes de referencia diciembre

$$Y_t=\beta_0+\beta_1t+\beta_2t^2+\sum_{i=1}^{12}\delta_iI_{i,t}+E_t, ~~~ E_t \sim iid N(0, \sigma^2)$$

## Modelo 2: Modelo c√∫bico estacional con indicadoras, mes de referencia diciembre

$$Y_t=\beta_0+\beta_1t+\beta_2t^2+\beta_3t^3+\sum_{i=1}^{12}\delta_iI_{i,t}+E_t, ~~~ E_t \sim iid N(0, \sigma^2)$$

## Modelos 3: Descomposici√≥n aditiva & Loess cuadr√°tico

En la vecindad de un tiempo $t_k$ donde se quiere ajustar, $Y_t = \beta_{0,k} + \beta_{1,k}t + \beta_{2,k}t^2 + \sum_{i=1}^{12}\delta_i I_{i,t} +  E_t, ~~ E_t \sim iid N(0,\sigma^2)$ para todo t vecino a $t_k$, con $\sum_{i=1}^{12}\delta_i=0,~~~ \beta_{0,k},~\beta_{1,k}~y~\beta_{2,k}$ los parametros de la parabola local en la vecindad de $t_k$


## Modelo 4: Suavizamiento exponencial Holt-Winters aditivo

$Y_{t+h} = \beta_{0,t} + \beta_{1,t}\times h + \sum_{i=1}^{12}\delta_{i,t} I_{i,t+h} +  E_{t+h}, ~~ E_t \sim iid N(0,\sigma^2)$, con $\sum_{i=1}^{12}\delta_{i,t}=0,~~\beta_{0,t}~y~\beta_{1,t}~y~\delta_{i,t}$, el nivel en $t$, la pendiente en $t$ y los efectos estacionales en $t$, respectivamente, cambiando lentamente en el tiempo.




## Ajuste de los modelos con validaci√≥n cruzada


```{r}
m <- 12 # numero de periodos a pronosticar dentro de la muestra
n <-length(Datos20)-m # tama√±o de la muestra para el ajuste
t <- 1:n #Indice de tiempo en los periodos de ajuste
```


* Datos para el ajuste:

```{r}
yt <- ts(Datos20[t], frequency = 12, start=c(2001, 1))
```


* Definiendo factor para estacionalidad pero solo para la regresion lineal modelo 1

* Creaci√≥n de las variables indicadoras para los datos de muestra
```{r}
mes <- seasonaldummy(yt) #Matriz con las 11 primeras variables Indicadoras mes


#Separando una a una las 11 variables indicadoras

I1 <- mes[,1]
I2 <- mes[,2]
I3 <- mes[,3]
I4 <- mes[,4]
I5 <- mes[,5]
I6 <- mes[,6]
I7 <- mes[,7]
I8 <- mes[,8]
I9 <- mes[,9]
I10 <- mes[,10]
I11 <- mes[,11]
```


* Creaci√≥n de las variables indicadoras para los datos de validaci√≥n cruzada


```{r}
tnuevo <- (n+1):length(Datos20)
ytnuevo <- ts(Datos20[tnuevo], frequency = 12, start = c(2019, 1))


mesnuevo <- seasonaldummy(yt, h=12)
#Separando una a una las 11 indicadoras para los tiempos de pron?stico
I1n=mesnuevo[,1]
I2n=mesnuevo[,2]
I3n=mesnuevo[,3]
I4n=mesnuevo[,4]
I5n=mesnuevo[,5]
I6n=mesnuevo[,6]
I7n=mesnuevo[,7]
I8n=mesnuevo[,8]
I9n=mesnuevo[,9]
I10n=mesnuevo[,10]
I11n=mesnuevo[,11]
```



## Ajuste del modelo 1 Modelo cuadr√°tico estacional con indicadoras


```{r}
mod1 <- lm(yt~t+I(t^2)+I1+I2+I3+I4+I5+I6+I7+I8+I9+I10+I11)
summary(mod1)
```


## Ajuste del modelo 2 Modelo c√∫bico estacional con indicadoras


```{r}
mod2 <- lm(yt~t+I(t^2)+I(t^3)+I1+I2+I3+I4+I5+I6+I7+I8+I9+I10+I11)
summary(mod2)
```


## Funciones a utilizar:

```{r}
#Creando funci√≥n para extraer correctamente estimaciones de los efectos estacionales ùúπùíä por filtro de descomposici√≥n
factoresdeltai=function(descom,s,estacionini){
if(estacionini==1){
deltasi=descom$figure
}
if(estacionini!=1){
j=estacionini;deltasi=c(descom$figure[(s-j+2):s],descom$figure[1:(s-j+1)])
}
deltasi
}
```


## Ajuste modelo 3 Descomposici√≥n aditiva & Loess cuadr√°tico


```{r}
#Descomposici√≥n aditiva de la serie recortada
descom=decompose(yt,type="additive")
```



```{r}
s=12 #Longitud del periodo estacional
```



```{r}
#Componente estacional estimada de la descomposici√≥n de la serie recortada
St=descom$seasonal


deltas_i=factoresdeltai(descom=descom,s=12,estacionini=1) #Obteniendo los s factores estacionales estimados


#el per√≠odo es s=12 y la serie arranca en estaci√≥n 1
data.frame(deltas_i)
```



```{r}
#Pron√≥sticos para la componente estacional usando estimaciones del filtro de descomposici√≥n cl√°sica

#los pron√≥sticos inician en enero 2019 y terminan en diciembre 2019

i=c(1,2,3,4,5,6,7,8,9,10,11,12) #identificando la estaci√≥n correspondiente a los m=12 per√≠odos de pron√≥sticos
```




```{r}
Stnuevo=deltas_i[i] #Asignando el valor de St a los periodos a pronosticar
Stnuevo=ts(Stnuevo,frequency=12,start=c(2019,1)) #convirtiendo en serie de tiempo al pron√≥stico de St
Stnuevo
```

```{r}
#Desestacionalizando o ajustando estacionalmente a la serie recortada, seg√∫n modelo aditivo
ytd=yt-St
```



```{r}
#LOESS cuadr√°tico (AICC) sobre serie desestacionalizada
ajusteLoess2=loess.as(t,ytd,degree=2,criterion="aicc",family="gaussian",plot=F)
summary(ajusteLoess2)
alfa.optim2=ajusteLoess2$pars$span #guardando el valor √≥ptimo del par√°metro alfa
```




## Ajuste modelo 4 con m√©todo Suavizamiento exponencial Holt-Winters aditivo

### Modelo de tendencia con cambio de nivel y pendiente, aditiva a factor estacional con efectos que evolucionan lentamente en el tiempo

```{r}
suav=HoltWinters(yt,seasonal="additive") #Suavizamiento con valores Ûptimos en par·metros ùú∂, ùú∑, ùú∏
suav
```


# Valores ajustados de los modelos 


Modelo 1

```{r}
mod1_ajust <- ts(fitted(mod1), start  = c(2001,1), frequency = 12)
```


```{r}
plot(Datos20)
lines(mod1_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste del modelo1"), lty=1, col=c(1,2))

```

Modelo 2

```{r}
mod2_ajust <- ts(fitted(mod2), start  = c(2001,1), frequency = 12)
```


```{r}
plot(Datos20)
lines(mod2_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste del modelo2"), lty=1, col=c(1,2))

```

modelo 3

```{r}
mod3_ajust <- ts(fitted(ajusteLoess2), start  = c(2001,1), frequency = 12)
ythat1 <- mod3_ajust + St # Ajuste D&LC(AICC)
```


```{r}
plot(Datos20)
lines(ythat1, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste D&LC(AICC)"), lty=1, col=c(1,2))

```




Modelo 4

```{r}
plot(Datos20)
lines(fitted(suav)[,1], col=2, lwd=2)
legend("topleft", legend=c("Original","Ajuste H-W"), col=c(1,2), lty=1)
```

# Calculo del AIC y BIC

```{r}
#Creando funci?n usuario crit.inf.resid() para calcular C^*_n(p)
crit.inf.resid <- function(residuales,n.par,AIC="TRUE"){
if(AIC=="TRUE"){
#Calcula AIC
CI=log(mean(residuales^2))+2*n.par/length(residuales)
}
if(AIC=="FALSE"){
#Calcula BIC
CI=log(mean(residuales^2))+n.par*log(length(residuales))/length(residuales)
}
CI
}  
```

modelo 1
```{r}
resmod1.orig <- residuals(mod1) #seudo-residuos en la escala original. Usados sÛlo para calcular AIC y BIC

npar1 <- length(coef(mod1)[coef(mod1)!=0]) #n˙mero par·metros modelo 1

aic1 <- exp(crit.inf.resid(resmod1.orig,n.par=npar1))
bic1 <- exp(crit.inf.resid(resmod1.orig ,n.par=npar1, AIC="FALSE"))
```

modelo 2
```{r}
resmod2.orig <- residuals(mod2) #seudo-residuos en la escala original. Usados sÛlo para calcular AIC y BIC

npar2 <- length(coef(mod2)[coef(mod2)!=0]) #n˙mero par·metros modelo 1

aic2 <- exp(crit.inf.resid(resmod1.orig,n.par=npar2))
bic2 <- exp(crit.inf.resid(resmod1.orig ,n.par=npar2, AIC="FALSE"))
```

modelo 3
```{r}
et3 <- yt - mod3_ajust

p3 <- round(ajusteLoess2$enp)+s-1
AIC3 <- exp(crit.inf.resid(residuales=et3,n.par=p3))
BIC3 <- exp(crit.inf.resid(residuales=et3,n.par=p3,AIC="FALSE"))
```

modelo 4
```{r}
p4 <- (s-1)+2 #Aprox. del n˙mero de par·metros del suavizamiento
AIC4 <- exp(crit.inf.resid(residuales=residuals(suav),n.par=p4))
BIC4 <- exp(crit.inf.resid(residuales=residuals(suav),n.par=p4,AIC="FALSE"))
```


# Preguntas orientadas para los analisis
## hacer tablas de los summary

 * En los modelos globales øSon significativos el polinomio considerado y la componente estacional con la representaciÛn que fue usada?

Modelo 1

Debido a que el valor ajustado para el coeficiente correspondiente al grado 2 del polinomio tiene un p-valor muy pequeÒo(menor a 0.05), se dice que es significativo y por lo tanto la estructura del polinomio cuadratico es significativa.
Por otro lado, ya que al menos uno de los coeficientes estimados asociados a las variables indicadoras, son significativos(p-valor menor a 0.05), en este caso todos, se concluye que la componente estacional es significativa.

Modelo 2

Debido a que el valor ajustado para el coeficiente correspondiente al grado 3 del polinomio tiene un p-valor grande(mayor a 0.05), se dice que no es significativo y por lo tanto la estructura del polinomio cubico no es significativa.
Por otro lado, ya que al menos uno de los coeficientes estimados asociados a las variables indicadoras, son significativos(p-valor menor a 0.05), en este caso todos, se concluye que la componente estacional es significativa.

 * En los modelos globales øCu·l es la interpretacio¥n de las estimaciones de los par·metros estacionales?, ødifieren mucho estas estimaciones entre los modelos globales? Adem·s, si se modelÛ con variables indicadoras,grafique en un mismo plano y en la escala original de la serie, el patrÛn estacional estimado øEstas estimaciones aproximan apropiadamente el patrÛn estacional?

Ya que la serie es aditiva, los $\delta_i$ es la diferencia entre la media de la serie en el mes i del aÒo menos la media en el periodo de referencia, es decir, diciembre.


__Hacer tabla con las estimaciones de los delta_i__


```{r}
p1 <- 2 # grado del polinomio modelo 1
p2 <- 3 # grado del polinomio modelo 2


efectosestac1 <- ts(c(coef(mod1)[(p1+2):npar1],0),freq=1,start=1)
efectosestac2 <- ts(c(coef(mod2)[(p2+2):npar2],0),freq=1,start=1)
#win.graph()
plot(efectosestac1,lwd=4,ylab="",xlab="Periodo del aÒo")
lines(efectosestac2,lty=2,col=2,lwd=4)
legend("topleft",legend=c("Modelo 1","Modelo 2"),col=1:2,lty=1:2,lwd=2)
```

Como se interpreta???

 * Compare gr·ficamente la forma de la estimaciÛn de la componente estacional entre los dos modelos locales(en Holt-Winters se toma el  ¥ultimo valor suavizado para cada uno de los 12 efectos estacionales) ødifieren mucho? Adem·s, si en los modelos globales se usaron indicadoras, compare la forma del patrÛn estacional estimado por estos vs. los locales øquÈ se interpreta a partir de la similaridad o diferencia entre estas estimaciones?
 
 
```{r}
#extracciÛn estimaciones en t=216 de efectos estacionales segun Holt-Winters.

deltasiHW=ts(suav$coef[c(3:14)],freq=1,start=1)#Estimaciones de los efectos estacionales segun filtro de descomposici¥on

deltasDescomp=ts(deltas_i,freq=1,start=1)
deltasilocales=data.frame(rbind(deltasiHW,deltasDescomp),row.names=c("HW","Descomp&loess"))
names(deltasilocales)=c(1:12)#Gr·fico de los efectos estacionales estimados
plot(deltasiHW,lwd=4,ylim=c(min(deltasiHW,deltasDescomp),max(deltasiHW,deltasDescomp)+0.05),ylab="",xlab="Mes del aÒo")
lines(deltasDescomp,lty=2,lwd=4,col=2)
legend("topleft",legend=c("Efectos estacionales H-W en t=216","Efectos estacionales Filtro de descomposiciÛn"),col=1:2,lty=1:2,lwd=3)
```

 * Con relaciÛn al ajuste loess de la serie desestacionalizada øQuÈ se concluye de su gr·fica y del n˙mero de par·metros equivalentes loess?
 
# GR¡FICOS DE LA SERIE DESESTACIONALIZADA Y SUS AJUSTES LOESS

```{r}
plot(ytd)
lines(mod3_ajust, col=2, lwd = 2)
legend("topleft", legend=c("Serie ajustada estacionalmente", "Tendencia LOESS cuadr·tico (AICC)"), col=c(1,2), lty=1)
``` 


Se observa que los valores ajustados se acercan a los valores que toma la serie; la componente ciclica que toma la serie esta presente ya que se puede observar que la tendencia no es una curva completamente suave. 

Finalmente el ajuste que hace LOESS al final de la serie es creciente, aunque el valor real muestra una tendencia decreciente

Para un ajuste global polinomial alcanzando el mismo ajuste que LOESS, el modelo global deberia ser un polinomial con aproximadamente 13 parametros.






