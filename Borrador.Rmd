---
title: "Borrador"
author: "Jennifer Salazar"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Falta hacer esto

Defina la variable de la serie, su unidad de medida, su construcci√≥n e interpretacion de sus cifras, perƒ±odos observados, frecuencia de observacion, total de observaciones y fuente de los datos.



# Librerias utiles

```{r}
library(forecast)
library(TSA)
library(fANCOVA)

```

```{r}
Datos20=read.table("anex-EMMET-dic2019-Fabricacion de otros productos quimicos (1).csv",header=T,sep=";",skip=14,dec=",",colClasses=c(rep("NULL",4),"numeric",rep("NULL",6)))
Datos20=ts(Datos20,freq=12,start=c(2001,1))
```



# An√°lisis descriptivo:

Se Consideran los datos sobre el √≠ndice de producci√≥n nominal de la clase otros productos quimicos sector de manufactura, de enero de 2001 a diciembre de 2019
(N=228), a√±o base 2018. Ver Figura 1(a).


## Descomposici√≥n aditiva (tendencia)

```{r}
Tt=decompose(Datos20)$trend
```


```{r}
par(mfrow=c(1,2))
plot(Datos20, sub="(a)", lwd=1.5)
grid()
plot(Tt,ylim=c(min(Datos20),max(Datos20)), sub="(b)", lwd=1.5, ylab=expression(T[t]))
grid()
```


**Figura 1.**  (a) √çndice de producci√≥n nominal de en Colombia sector manufactura,
Clase industrial: otros productos quimicos. Enero 2001 - diciembre 2019; (b) Tendencia seg√∫n el filtro de descomposici√≥n aditiva.


De la Figura 1(a) se deduce la presencia de estacionalidad y tendencia aditivas,  es aditiva dado que su varianza es constante alrededor de su trayectoria de largo plazo(tendencia). En la Figura 1(b) es visible que la serie es de tendencia creciente y que existen ciclos. 


##  grafico de boxplots comparativos de la distribucion de la serie versus perƒ±odos del a√±o calendario

## Periodograma

```{r}
par(mfrow=c(2,2))
boxplot(Datos20~cycle(Datos20), names=month.abb, ylab="Producci√≥n nominal", xlab = "Meses del a√±o", sub="(a)")
grid()
periodogram(diff(Datos20),lwd=4, sub="(b)") #periodograma sobre los logaritmos diferenciados
abline(v=c(1:6)/12,col=2,lty=2)
grid()
```


**Figura 2.** (a) Boxplots: distribuci√≥n por meses de la serie. (b) Periodograma
sobre las diferencias de la serie.

De la figura 2(a) en los boxplots comparativos se ve c√≥mo la media (o mediana) de la distribuci√≥n de la serie seg√∫n el periodo del a√±o, cambia a lo largo de un a√±o calendario siendo menor en los meses de enero, febrero, abril y diciembre comparados con el resto del a√±o. Tiene un crecimiento de enero a marzo y luego vuelve y baja en abril  para volver a subir en mayo manteniendose relativamente al mismo nivel en los siguientes meses hasta noviembre, para luego decaer en diciembre y retormar el siguiente a√±o; se confirma que existe un patr√≥n peri√≥dico anual con una forma constante en el tiempo.




De la figura 2(b) Periodograma: muestra la asociacion de la serie con cinco componentes periodicas (valor alto del periodograma en esas frecuencias): en las frecuencias 1/12 y 2/12, 3/12, 4/12, 6/12. El periodograma reafirma la existencia de componente estacional.

# justifique por que existe componente estacional y si su forma es constante o no en el tiempo. 

- Mediante el gr√°fico de la serie vs el tiempo se ve un patr√≥n que se repite cada a√±o; pues en cada a√±o se observa que en los meses del inicio y del final el √≠ndice de producci√≥n nominal es bajo y tiene aproximadamente 2 picos de decaimiento en el transcurso del a√±o.

- Dado que en el gr√°fico de boxplot al menos una de las medias de los meses cambia respecto al resto de los meses del a√±o calendario, por lo tanto se concluye que cada periodo en que se divide el a√±o calendario determina una estaci√≥n, la cual tiene incidencia sobre el valor medio de la serie, por ellos se dice que existe la componente estacional.

- Mediante el periodograma se resalta que hay una asociaci√≥n de la serie con fenomenos periodicos, indicando la existencia de una componente estacional.


## Es la estacionalidad constante o no en el tiempo:

```{r}
par(mfrow=c(2,2))
plot(Datos20, xlim=c(2001,2005))
plot(Datos20, xlim=c(2006,2010))
plot(Datos20, xlim=c(2011,2015))
plot(Datos20, xlim=c(2016,2019))

```


## la tendencia se puede ajustar globalmente o si es local.

- La tendencia de la serie es global ya que se puede ajustar una curva suave creciente en todos los tiempos de la serie, Tambi√©n se puede ajustar modelos locales para comparar los ajustes y pronosticos respecto a la ajuste global.



##  identificacion de posibles ciclos y cambios estructurales.

* Hay presencia de ciclos en la serie a tr√°ves del tiempo ya que al aplicar la descomposici√≥n aditiva y obtener la tendencia, no se observa una curva suave que describa la tendencia de la serie.
* Hay aproximadamente entre 4 y 5 ciclos en la serie a trav√©s del tiempo (monta√±as).
* Parace haber posible cambio estructural en la serie en el 2015 ya que el nivel de la serie cambia un poco a partir de ese a√±o.




#################################################################################


# Modelos propuestos


Por el an√°lisis descriptivo, para los modelos globales la tendencia puede ser ajustada por un polinomio de grado $p = 2, 3$ y la componente estacional puede representarse como un factor y por tanto usar  variables indicadoras en los modelos globales. Se proponen los siguientes modelos de regresi√≥n, donde t es el √≠ndice de tiempo y $I_{i,t}$ es la indicadora del trimestre i en el tiempo t.


$$\text{Tabla 1. Ecuaci√≥n de los modelos propuestos}$$
$$\begin{array}{|c|}
\hline
\text{ Modelo 1: Modelo cuadr√°tico estacional con indicadoras, mes de referencia diciembre}\\
Y_t=\beta_0+\beta_1t+\beta_2t^2+\sum_{i=1}^{11}\delta_iI_{i,t}+E_t, ~~~ E_t \sim iid N(0, \sigma^2)\\
\hline
\text{Modelo 2: Modelo c√∫bico estacional con indicadoras, mes de referencia diciembre}\\
Y_t=\beta_0+\beta_1t+\beta_2t^2+\beta_3t^3+\sum_{i=1}^{11}\delta_iI_{i,t}+E_t, ~~~ E_t \sim iid N(0, \sigma^2)\\
\hline
\text{Modelos 3: Descomposici√≥n aditiva & Loess cuadr√°tico}\\
\text{En la vecindad de un tiempo} ~t_k~ \text{donde se quiere ajustar} 
Y_t = \beta_{0,k} + \beta_{1,k}t + \beta_{2,k}t^2 + \sum_{i=1}^{12}\delta_i I_{i,t} +  E_t, ~~ E_t \sim iid N(0,\sigma^2) \\
\text{para todo t vecino a} ~~t_k,~~ \text{con} \sum_{i=1}^{12}\delta_i=0,~~~ \beta_{0,k},~\beta_{1,k}~y~\beta_{2,k}~~ \text{los par√°metros de la par√°bola local en la vecindad de} ~~t_k\\
\hline
\text{Modelo 4: Suavizamiento exponencial Holt-Winters aditivo}\\
Y_{t+h} = \beta_{0,t} + \beta_{1,t}\times h + \sum_{i=1}^{12}\delta_{i,t} I_{i,t+h} +  E_{t+h}, ~~ E_t \sim iid N(0,\sigma^2),\text{con} \sum_{i=1}^{12}\delta_{i,t}=0,~~\beta_{0,t}~y~\beta_{1,t}~y~\delta_{i,t}, \text{el nivel en} ~~t,~~\\
\text{la pendiente en} ~~t~~ \text{y los efectos estacionales en t, respectivamente, cambiando lentamente en el tiempo.}\\
\hline
\end{array}$$


## Modelo 1: Modelo cuadr√°tico estacional con indicadoras, mes de referencia diciembre

$$Y_t=\beta_0+\beta_1t+\beta_2t^2+\sum_{i=1}^{11}\delta_iI_{i,t}+E_t, ~~~ E_t \sim iid N(0, \sigma^2)$$

## Modelo 2: Modelo c√∫bico estacional con indicadoras, mes de referencia diciembre

$$Y_t=\beta_0+\beta_1t+\beta_2t^2+\beta_3t^3+\sum_{i=1}^{11}\delta_iI_{i,t}+E_t, ~~~ E_t \sim iid N(0, \sigma^2)$$

## Modelos 3: Descomposici√≥n aditiva & Loess cuadr√°tico

En la vecindad de un tiempo $t_k$ donde se quiere ajustar, $Y_t = \beta_{0,k} + \beta_{1,k}t + \beta_{2,k}t^2 + \sum_{i=1}^{12}\delta_i I_{i,t} +  E_t, ~~ E_t \sim iid N(0,\sigma^2)$ para todo t vecino a $t_k$, con $\sum_{i=1}^{12}\delta_i=0,~~~ \beta_{0,k},~\beta_{1,k}~y~\beta_{2,k}$ los parametros de la parabola local en la vecindad de $t_k$


## Modelo 4: Suavizamiento exponencial Holt-Winters aditivo

$Y_{t+h} = \beta_{0,t} + \beta_{1,t}\times h + \sum_{i=1}^{12}\delta_{i,t} I_{i,t+h} +  E_{t+h}, ~~ E_t \sim iid N(0,\sigma^2)$, con $\sum_{i=1}^{12}\delta_{i,t}=0,~~\beta_{0,t}~y~\beta_{1,t}~y~\delta_{i,t}$, el nivel en $t$, la pendiente en $t$ y los efectos estacionales en $t$, respectivamente, cambiando lentamente en el tiempo.


# Ajustes

## Ajuste de los modelos con validaci√≥n cruzada

Se implementa la estrategia de validaci√≥n cruzada excluyendo del ajuste los √∫ltimos 
$m = 12$ datos, que comprende de enero de 2001 a diciembre de 2018 por tanto, la validaci√≥n cruzada se har√° con los pron√≥sticos ex-post
de estos √∫ltimos.



```{r}
m <- 12 # numero de periodos a pronosticar dentro de la muestra
n <-length(Datos20)-m # tama√±o de la muestra para el ajuste
t <- 1:n #Indice de tiempo en los periodos de ajuste
```


* Datos para el ajuste:

```{r}
yt <- ts(Datos20[t], frequency = 12, start=c(2001, 1))
```



* Creaci√≥n de las variables indicadoras para los datos de muestra
```{r}
mes <- seasonaldummy(yt) #Matriz con las 11 primeras variables Indicadoras mes


#Separando una a una las 11 variables indicadoras

I1 <- mes[,1]
I2 <- mes[,2]
I3 <- mes[,3]
I4 <- mes[,4]
I5 <- mes[,5]
I6 <- mes[,6]
I7 <- mes[,7]
I8 <- mes[,8]
I9 <- mes[,9]
I10 <- mes[,10]
I11 <- mes[,11]
```


* Creaci√≥n de las variables indicadoras para los datos de validaci√≥n cruzada


```{r}
tnuevo <- (n+1):length(Datos20)
ytnuevo <- ts(Datos20[tnuevo], frequency = 12, start = c(2019, 1))


mesnuevo <- seasonaldummy(yt, h=12)
#Separando una a una las 11 indicadoras para los tiempos de pron?stico
I1n=mesnuevo[,1]
I2n=mesnuevo[,2]
I3n=mesnuevo[,3]
I4n=mesnuevo[,4]
I5n=mesnuevo[,5]
I6n=mesnuevo[,6]
I7n=mesnuevo[,7]
I8n=mesnuevo[,8]
I9n=mesnuevo[,9]
I10n=mesnuevo[,10]
I11n=mesnuevo[,11]
```



## Ajuste del modelo 1 Modelo cuadr√°tico estacional con indicadoras


```{r}
mod1 <- lm(yt~t+I(t^2)+I1+I2+I3+I4+I5+I6+I7+I8+I9+I10+I11)
resumen1 <- summary(mod1)
```

```{r}
kbl(dt, booktabs = T)%>%column_spec(1, bold = T)%>%save_kable("my_latex_table.png")
```


## Ajuste del modelo 2 Modelo c√∫bico estacional con indicadoras


```{r}
mod2 <- lm(yt~t+I(t^2)+I(t^3)+I1+I2+I3+I4+I5+I6+I7+I8+I9+I10+I11)
summary(mod2)
```


## Funciones a utilizar:

```{r}
#Creando funci√≥n para extraer correctamente estimaciones de los efectos estacionales ùúπùíä por filtro de descomposici√≥n
factoresdeltai=function(descom,s,estacionini){
if(estacionini==1){
deltasi=descom$figure
}
if(estacionini!=1){
j=estacionini;deltasi=c(descom$figure[(s-j+2):s],descom$figure[1:(s-j+1)])
}
deltasi
}
```


## Ajuste modelo 3 Descomposici√≥n aditiva & Loess cuadr√°tico


```{r}
#Descomposici√≥n aditiva de la serie recortada
descom=decompose(yt,type="additive")
```



```{r}
s=12 #Longitud del periodo estacional
```



```{r}
#Componente estacional estimada de la descomposici√≥n de la serie recortada
St=descom$seasonal


deltas_i=factoresdeltai(descom=descom,s=12,estacionini=1) #Obteniendo los s factores estacionales estimados


#el per√≠odo es s=12 y la serie arranca en estaci√≥n 1
deltas <- data.frame(deltas_i)
deltas
```


$$\begin{array}{| c | c | c | c| c |}
\hline
i& \hat{\delta}_i\\
\hline
1&-10.8780433\\
2&-2.3143178\\
3&4.3650940\\
4&-0.5319649\\
5&4.3979371\\
6&2.0783292\\
7&0.7969567\\
8&1.2373979\\
9&4.6148489\\
10&2.5229371\\
11&1.0633783\\
12&-7.3525531\\
\hline
suma & 0\\
\hline
\end{array}$$



```{r}
#Pron√≥sticos para la componente estacional usando estimaciones del filtro de descomposici√≥n cl√°sica

#los pron√≥sticos inician en enero 2019 y terminan en diciembre 2019

i=c(1,2,3,4,5,6,7,8,9,10,11,12) #identificando la estaci√≥n correspondiente a los m=12 per√≠odos de pron√≥sticos
```




```{r}
Stnuevo=deltas_i[i] #Asignando el valor de St a los periodos a pronosticar
Stnuevo=ts(Stnuevo,frequency=12,start=c(2019,1)) #convirtiendo en serie de tiempo al pron√≥stico de St
Stnuevo
```

```{r}
#Desestacionalizando o ajustando estacionalmente a la serie recortada, seg√∫n modelo aditivo
ytd=yt-St
```



```{r}
#LOESS cuadr√°tico (AICC) sobre serie desestacionalizada
mod3=loess.as(t,ytd,degree=2,criterion="aicc",family="gaussian",plot=F)
summary(mod3)
alfa.optim2=mod3$pars$span #guardando el valor √≥ptimo del par√°metro alfa
```




## Ajuste modelo 4 con m√©todo Suavizamiento exponencial Holt-Winters aditivo

### Modelo de tendencia con cambio de nivel y pendiente, aditiva a factor estacional con efectos que evolucionan lentamente en el tiempo

```{r}
mod4=HoltWinters(yt,seasonal="additive") #Suavizamiento con valores Optimos en parametros ùú∂, ùú∑, ùú∏
mod4
```


# Valores ajustados de los modelos 


Modelo 1

```{r}
mod1_ajust <- ts(fitted(mod1), start  = c(2001,1), frequency = 12)
```


```{r}
plot(Datos20)
lines(mod1_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste del modelo1"), lty=1, col=c(1,2))

```

Modelo 2

```{r}
mod2_ajust <- ts(fitted(mod2), start  = c(2001,1), frequency = 12)
```


```{r}
plot(Datos20)
lines(mod2_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste del modelo2"), lty=1, col=c(1,2))

```

modelo 3

```{r}
mod3_Tt <- ts(fitted(mod3), start  = c(2001,1), frequency = 12)
mod3_ajust <- mod3_Tt + St # Ajuste D&LC(AICC)
```


```{r}
plot(Datos20)
lines(mod3_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste D&LC(AICC)"), lty=1, col=c(1,2))

```




Modelo 4

```{r}
mod4_ajust <- fitted(mod4)[,1]
plot(Datos20)
lines(mod4_ajust, col=2, lwd=2)
legend("topleft", legend=c("Original","Ajuste H-W"), col=c(1,2), lty=1)
```

# Calculo del AIC y BIC

```{r}
#Creando funci?n usuario crit.inf.resid() para calcular C^*_n(p)
crit.inf.resid <- function(residuales,n.par,AIC="TRUE"){
if(AIC=="TRUE"){
#Calcula AIC
CI=log(mean(residuales^2))+2*n.par/length(residuales)
}
if(AIC=="FALSE"){
#Calcula BIC
CI=log(mean(residuales^2))+n.par*log(length(residuales))/length(residuales)
}
CI
}  
```

modelo 1
```{r}
resmod1.orig <- residuals(mod1) #seudo-residuos en la escala original. Usados s?lo para calcular AIC y BIC

npar1 <- length(coef(mod1)[coef(mod1)!=0]) #n?mero par?metros modelo 1

aic1 <- exp(crit.inf.resid(resmod1.orig,n.par=npar1))
bic1 <- exp(crit.inf.resid(resmod1.orig ,n.par=npar1, AIC="FALSE"))
```

modelo 2
```{r}
resmod2.orig <- residuals(mod2) #seudo-residuos en la escala original. Usados s?lo para calcular AIC y BIC

npar2 <- length(coef(mod2)[coef(mod2)!=0]) #n?mero par?metros modelo 1

aic2 <- exp(crit.inf.resid(resmod1.orig,n.par=npar2))
bic2 <- exp(crit.inf.resid(resmod1.orig ,n.par=npar2, AIC="FALSE"))
```

modelo 3
```{r}
et3 <- yt - mod3_ajust

p3 <- round(mod3$enp)+s-1
AIC3 <- exp(crit.inf.resid(residuales=et3,n.par=p3))
BIC3 <- exp(crit.inf.resid(residuales=et3,n.par=p3,AIC="FALSE"))
```

modelo 4
```{r}
p4 <- (s-1)+2 #Aprox. del n?mero de par?metros del suavizamiento
AIC4 <- exp(crit.inf.resid(residuales=residuals(mod4),n.par=p4))
BIC4 <- exp(crit.inf.resid(residuales=residuals(mod4),n.par=p4,AIC="FALSE"))
```





# Preguntas orientadas para los analisis
## hacer tablas de los summary

 * En los modelos globales ¬øSon significativos el polinomio considerado y la componente estacional con la representaci√≥n que fue usada?

Modelo 1

Debido a que el valor ajustado para el coeficiente correspondiente al grado 2 del polinomio tiene un p-valor muy peque?o(menor a 0.05), se dice que es significativo y por lo tanto la estructura del polinomio cuadratico es significativa.
Por otro lado, ya que al menos uno de los coeficientes estimados asociados a las variables indicadoras, son significativos(p-valor menor a 0.05), en este caso todos, se concluye que la componente estacional es significativa.

Modelo 2

Debido a que el valor ajustado para el coeficiente correspondiente al grado 3 del polinomio tiene un p-valor grande(mayor a 0.05), se dice que no es significativo y por lo tanto la estructura del polinomio cubico no es significativa.
Por otro lado, ya que al menos uno de los coeficientes estimados asociados a las variables indicadoras, son significativos(p-valor menor a 0.05), en este caso todos, se concluye que la componente estacional es significativa.

En los modelos globales ¬øCu√°l es la interpretaci√≥n de las estimaciones de los par√°metros estacionales?, ¬ødifieren mucho estas estimaciones entre los modelos globales? Adem√°s, si se modelo con variables indicadoras, grafique en un mismo plano y en la escala original de la serie, el patr√≥n estacional estimado ¬øEstas estimaciones aproximan apropiadamente el patr√≥n estacional? Esta gr√°fica puede realizarse de la siguiente manera: Suponga que los modelos son ajustados en R bajo los objetos de nombre mod1 y mod2 respectivamente. Sean p1 y p2 los ordenes de los respectivos polinomios, nparmod1 y nparmod2 el n√∫mero de par√°metros, de cada
modelo, respectivamente. En el caso aditivo, proceda as√≠:

Ya que la serie es aditiva, los $\delta_i$ es la diferencia entre la media de la serie en el mes i del a√±o menos la media en el periodo de referencia, es decir, diciembre.


(.............Hacer tabla con las estimaciones de los delta_i y dar m√°s conclusiones.....)

```{r}
summary(mod1)
summary(mod2)
```



```{r}
p1 <- 2 # grado del polinomio modelo 1
p2 <- 3 # grado del polinomio modelo 2


efectosestac1 <- ts(c(coef(mod1)[(p1+2):npar1],0),freq=1,start=1)
efectosestac2 <- ts(c(coef(mod2)[(p2+2):npar2],0),freq=1,start=1)
#win.graph()
plot(efectosestac1,lwd=4,ylab="",xlab="Periodo del a√±o")
lines(efectosestac2,lty=2,col=2,lwd=4)
legend("topleft",legend=c("Modelo 1","Modelo 2"),col=1:2,lty=1:2,lwd=2)
```


Vemos que el mod1 y el mod2 estiman la misma forma para $S_t$ adem√°s de que sus valores son muy similares para los efectos estacionales (no son iguales pero tinen diferencias muy peque√±as en las estimaciones de los $\delta_i$)

Como se interpreta??? (...comentar........)



 * Compare gr√°ficamente la forma de la estimaci√≥n de la componente estacional entre los dos modelos locales(en Holt-Winters se toma el  √∫ltimo valor suavizado para cada uno de los 12 efectos estacionales) ¬ødifieren mucho? Adem√°s, si en los modelos globales se usaron indicadoras, compare la forma del patr√≥n estacional estimado por estos vs. los locales ¬øqu√© se interpreta a partir de la similaridad o diferencia entre estas estimaciones?
 
 
```{r}
#extracci√≥n estimaciones en t=216 de efectos estacionales segun Holt-Winters.

deltasiHW=ts(mod4$coef[c(3:14)],freq=1,start=1)#Estimaciones de los efectos estacionales segun filtro de descomposici√≥on

deltasDescomp=ts(deltas_i,freq=1,start=1)
deltasilocales=data.frame(rbind(deltasiHW,deltasDescomp),row.names=c("HW","Descomp&loess"))
names(deltasilocales)=c(1:12)#Gr√°fico de los efectos estacionales estimados


plot(deltasiHW,lwd=4,ylim=c(min(deltasiHW,deltasDescomp),max(deltasiHW,deltasDescomp)+0.05),ylab="",xlab="Mes del a√±o")
lines(deltasDescomp,lty=2,lwd=4,col=2)
legend("topleft",legend=c("Efectos estacionales H-W en t=216","Efectos estacionales Filtro de descomposici√≥n"),col=1:2,lty=1:2,lwd=3)
```


* Se observa que hay algunas diferencias entre las estimaciones "globales" que da el filtro con respecto a "la √∫ltima estimaci√≥n local" que da SEHW; sin embargo, la "forma del patr√≥n" estimado es igual. Por lo tanto, $S_t$ en $Y_t$ es m√°s o menos estable en el tiempo.



```{r}
plot(efectosestac1,lwd=4,xlab="Periodo del a√±o", ylim =c(-10, 23))
lines(efectosestac2,lty=2,col=2,lwd=4)
lines(deltasiHW,lwd=3, col=3)
lines(deltasDescomp,lty=2,lwd=4,col=4)
legend("topleft",legend=c("Polinomial cuadr√°tico","Polinomial c√∫bico", "SEHW","DLC"),col=1:4,lwd=3, cex=0.8)
```


* Vemo que los modelos globales estiman la misma forma de $S_t$ pero con valores diferentes de los efectos estacionales al no coindir los $\delta_i$

<br>


Con relaci√≥n al ajuste loess de la serie desestacionalizada ¬øQu√© se concluye de su gr√°fica y del n√∫mero de par√°metros equivalentes loess?
 
# GR√ÅFICOS DE LA SERIE DESESTACIONALIZADA Y SUS AJUSTES LOESS

```{r}
plot(ytd)
lines(mod3_Tt, col=2, lwd = 2)
legend("topleft", legend=c("Serie ajustada estacionalmente", "Tendencia LOESS cuadr√°tico (AICC)"), col=c(1,2), lty=1)
``` 


Se observa que los valores ajustados se acercan a los valores que toma la serie; la componente ciclica que toma la serie esta presente ya que se puede observar que la tendencia no es una curva completamente suave. 

Finalmente el ajuste que hace LOESS al final de la serie es creciente, aunque el valor real muestra una tendencia decreciente

Para un ajuste global polinomial alcanzando el mismo ajuste que LOESS, el modelo global deberia ser un polinomial con aproximadamente 13 par√°metros.


<br>


¬øQu√© se concluye sobre la calidad del ajuste de los modelos globales vs. locales? tambi√©n determine entre los modelos globales cu√°l modelo recomendar√≠a inicialmente como mejor modelo global para ajustar la serie. Tenga en cuenta no s√≥lo los valores de los criterios de informaci√≥n, sino tambi√©n los resultados gr√°ficos.





```{r}
par(mfrow=c(2,2))
plot(Datos20)
lines(mod1_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste del modelo1"), lty=1, col=c(1,2), cex=0.5)

plot(Datos20)
lines(mod2_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste del modelo2"), lty=1, col=c(1,2), cex=0.5)

plot(Datos20)
lines(mod3_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste D&LC(AICC)"), lty=1, col=c(1,2), cex=0.5)

plot(Datos20)
lines(mod4_ajust, col=2, lwd=2)
legend("topleft", legend=c("Original","Ajuste H-W"), col=c(1,2), lty=1, cex=0.5)
```


(....... Colocar la tabla de los AIC y BIC de todos los modelos y sacar una conclusi√≥n a partir de el)

* En general mediante los gr√°ficos tiene un mejor ajuste los modelos locales que los globales


*  Entre los modelos globales se recomienda el modelo cuadr√°tico con indicadoras ya que con un grado menos del polinomio ajusta igual de bien que el c√∫bico, por tanto se prefiere por ser un modelo m√°s simple (parsimonioso) adem√°s que en los ajustes se noto que el grado 3 del polinomio del segundo modelo no es significativo.



# 4. An√°lisis de residuales y validaci√≥n de supuestos: Para todos los modelos ajustados, globales y locales, realice el an√°lisis comparativo de residuales.


Gr√°fico de los residuales en el tiempo

```{r}
par(mfrow=c(2,2))

# Residuales vs tiempo mod1
plot.ts(residuals(mod1))
abline(h=c(-2*summary(mod1)$sigma, 0, 2*summary(mod1)$sigma), col=2)
legend("topleft", legend=c("Modelo1"), lty=1, col = 1, lwd=2)


# Residuales vs tiempo mod2
plot.ts(residuals(mod2))
abline(h=c(-2*summary(mod2)$sigma, 0, 2*summary(mod2)$sigma), col=2)
legend("topleft", legend=c("Modelo2"), lty=1, col = 1, lwd=2)


# Residuales vs tiempo mod3
df=n-(round(mod3$enp)+s-1) #Grados de libertad aproximados del ajuste total
MSE3=sum(et3^2)/df #MSE aproximado del ajuste total del modelo 3
plot(et3,ylim=c(min(-2*sqrt(MSE3),et3),max(2*sqrt(MSE3),et3)))
abline(h=c(-2*sqrt(MSE3),0,2*sqrt(MSE3)),col=2)
legend("topleft", legend=c("Modelo3"), lty=1, col = 1, lwd=2)


# Residuales vs tiempo mod4

et4=residuals(mod4)
df4=n-2*s-((s-1)+2)
MSE4=mod4$SSE/df4 #MSE aproximado del ajuste total del Suavizamiento

plot(et4,ylim=c(min(-2*sqrt(MSE4),et4),max(2*sqrt(MSE4),et4)))
abline(h=c(-2*sqrt(MSE4),0,2*sqrt(MSE4)),col=2)
legend("topleft", legend=c("Modelo4"), lty=1, col = 1, lwd=2)



```

```{r}

par(mfrow=c(2,2))
# Residuales vs valores ajustados mod1

plot(fitted(mod1), residuals(mod1))
abline(h=c(-2*summary(mod1)$sigma, 0, 2*summary(mod1)$sigma), col=2)
legend("topleft", legend=c("Modelo1"), lty=1, col = 1, lwd=2,cex = 0.8)


# Residuales vs valores ajustados mod2

plot(fitted(mod2), residuals(mod2))
abline(h=c(-2*summary(mod2)$sigma, 0, 2*summary(mod2)$sigma), col=2)
legend("topleft", legend=c("Modelo2"), lty=1, col = 1, lwd=2,cex = 0.8)

# Residuales vs valores ajustados mod3
plot(as.numeric(mod3_ajust),et3,ylim=c(min(-2*sqrt(MSE3),et3),max(2*sqrt(MSE3),et3)))
abline(h=c(-2*sqrt(MSE3),0,2*sqrt(MSE3)),col=2)
legend("topleft", legend=c("Modelo3"), lty=1, col = 1, lwd=2,cex = 0.8)

# Residuales vs valores ajustados mod4

plot(as.numeric(mod4_ajust),et4,ylim=c(min(-2*sqrt(MSE4),et4),max(2*sqrt(MSE4),et4)))
abline(h=c(-2*sqrt(MSE4),0,2*sqrt(MSE4)),col=2)
legend("topleft", legend=c("Modelo4"), lty=1, col = 1, lwd=2,cex = 0.8)
```

* Sobre el supuesto de media cero para los errores de ajuste ¬øqu√© se concluye en los cuatro modelos?

En las figuras presentadas en las gr√°ficas de residuos vs. tiempo y vs. valores ajustados, no se observa evidencia contra el supuesto de que los errores tienen media cero (a pesar de la variaci√≥n c√≠clica alrededor de cero, que se observa en las series de tiempo de los residuos de los modelos globales), pues en todos los casos los residuos parecen bien centrados en cero.


* ¬øEs v√°lido el supuesto de varianza constante en los 4 modelos?

Se observa una distribuci√≥n relativamente homog√©nea de los residuos alrededor de cero, es decir, no hay evidencias contrariando el supuesto de varianza constante para los errores de ajuste 


* ¬øHay patrones en los residuos que indiquen carencia de ajuste de los modelos en la tendencia y/o la estacionalidad?

No hay evidencia de carencia de ajuste severa en las componentes estructurales (o sea en tendencia y estacionalidad), pues en los residuos vs. valores ajustados no se observan patrones claros con forma de U o de W que indiquen mal ajuste de la tendencia, ni patrones peri√≥dicos en las gr√°ficas de las series de tiempo de residuos de ajuste que indiquen mal ajuste de la estacionalidad.


* ¬øHay ciclos presentes en los residuales? ¬øqu√© se deriva de estos patrones?

En las series de tiempo de los residuos de los modelos globales hay evidencia de ciclos no explicados (los cuales se dan centrados en cero), esto implica que los errores en los modelos globales, separados un periodo en el tiempo, est√°n positivamente correlacionados, es decir, $Corr(E_t,E_{t+1}) > 0$, por lo cual ya no es v√°lido el supuesto de independencia.

Por el contrario, en las series de tiempo de los residuos de los dos modelos locales no son observables a simple vista patrones c√≠clicos, aunque esto no es una garant√≠a suficiente para afirmar la validez de la independencia entre los errores de ajuste de estos dos modelos, es un punto su favor.


* ¬øQu√© hacen mejor los m√©todos locales vs. los globales?

Los m√©todos locales logran seguir ciclos, por eso son mejores que los modelos globales.


* ¬øCu√°l es el mejor modelo de los cuatro, de acuerdo al an√°lisis de los residuales?

Con todo lo antes dicho, de los 4 modelos, se considera que los modelos de ajuste local son mejores, ya que en ellos no hay patrones c√≠clicos y por tanto dan indicios de cumplir el supuesto de independencia.


# 5. Pron√≥sticos para la validaci√≥n cruzada: Para todos los modelos de ajuste global y local presentados, presente los resultados y an√°lisis de pron√≥sticos puntuales y por intervalos.

#### Hacer tabla de ecuaciones de pron√≥stico
#### Tabla con los pron√≥sticos

$$\hat{Y}_{216} = $$

Modelo 1

```{r}
ytpron1 <- predict(mod1, newdata=data.frame(t=tnuevo, I1=I1n, I2=I2n, I3=I3n, I4=I4n, I5=I5n, I6=I6n, I7=I7n, I8=I8n, I9=I9n, I10=I10n, I11=I11n), interval="prediction")
ytpron1 <- ts(ytpron1,freq=12,start=c(2019,1))
ytpron1
```

Modelo 2

```{r}
ytpron2 <- predict(mod2, newdata=data.frame(t=tnuevo, I1=I1n, I2=I2n, I3=I3n, I4=I4n, I5=I5n, I6=I6n, I7=I7n, I8=I8n, I9=I9n, I10=I10n, I11=I11n), interval="prediction")
ytpron2 <- ts(ytpron2,freq=12,start=c(2019,1))
ytpron2
```


Modelo 3

```{r}
#Pron√≥sticos de la tendencia por loess cuadr√°tico √≥ptimo (AICC)
Ttnuevo3 <- predict(loess(ytd~t,span=alfa.optim2,degree=2,control=loess.control(surface="direct")),
data.frame(t=tnuevo),se=FALSE)
Ttnuevo3 <- ts(Ttnuevo3,freq=12,start=c(2019,1)) #convirtiendo en serie de tiempo al pron√≥stico de Tt, modelo 3
ytpron3 <- Ttnuevo3 + Stnuevo #Pron√≥stico puntual Modelo 2
#Tabla con pron√≥sticos de las componentes y de la serie, Modelo 2
tablapron3 <- cbind(Pron_Tt=Ttnuevo3,Pron_St=Stnuevo,Pron_serie=ytpron3)
tablapron3
```

Modelo 4

```{r}
pronos4 <- predict(mod4, n.ahead=12,prediction=T,level=0.95)
ytpron4 <- pronos4[,1] #s√≥lo los pron√≥sticos puntuales del suavizamiento
```

Preguntas orientadas

* ¬øCu√°l es la interpretaci√≥n de los pron√≥sticos puntuales y sus I.P? Ejemplificar con una fecha y comparar entre modelos.

La producci√≥n nominal de la categor√≠a otros productos qu√≠micos para el mes de Junio de 2019, comparado con los meses del a√±o 2018 es de:

+ En el __modelo global cuadr√°tico__ : 109.59040 % es decir, durante este periodo aument√≥ un 9.59%. Adem√°s, con un 95% de confianza el valor real del √≠ndice se encuentra entre 101.46257 y 117.9377. 

+ En el __modelo global c√∫bico__ : 110.57743% es decir, durante este periodo aument√≥ aproximadamente un 10.57%. Adem√°s, con un 95% de confianza el valor real del √≠ndice se encuentra entre 102.12208 y 119.0328 .

+ En el __modelo local con Descomposici√≥n aditiva & Loess cuadr√°tico (DLC)__ : 109.12959 es decir, durante este periodo aument√≥ aproximadamente un 9.13%.

+ En el __modelo local aditivo con SEHW__: 107.96878% es decir, durante este periodo aument√≥ aproximadamente un 7.9%. Adem√°s, con un 95% de confianza el valor real del √≠ndice se encuentra entre 99.45046 y 116.48710  

* ¬øCu√°l es la interpretaci√≥n de las medidas MAE, MAPE y RMSE? ¬øseg√∫n estas medidas cu√°l modelo pronostica mejor?


(....Poner los sigueintes resultados en una tabla..las medidas de pronosticos....)

# Medidas en todos los modelos

```{r}
accuracy(ytpron1,ytnuevo) #Modelo 1
accuracy(ytpron2,ytnuevo) #Modelo 2
accuracy(ytpron3,ytnuevo) #Modelo 3
accuracy(ytpron4,ytnuevo) #Modelo 4
```

Interpretaciones:

  - Modelo 1:
  
  En promedio en cada pronostico se estima un error de +- 3.153708 puntos del indice de producci√≥n nominal seg√∫n el RMSE y de +- 2.366654 puntos del indice de producci√≥ nominal seg√∫n MAE, mientras que MAPE estima que en promedio cada pronostico se comete un error de +-2.338% con relaci√≥n al valor real del indice de producci√≥n nominal, todo esto en el modelo de regresi√≥n cuadr√°tico con variables indicadores
  
     
  - Modelo 2:
  
  En promedio en cada pronostico se estima un error de +- 3.620468 puntos del indice de producci√≥n nominal seg√∫n el RMSE y de +- 2.746457 puntos del indice de producci√≥ nominal seg√∫n MAE, mientras que MAPE estima que en promedio cada pronostico se comete un error de +- 2.71% con relaci√≥n al valor real del indice de producci√≥n nominal, todo esto en el modelo de regresi√≥n c√∫bico con variables indicadores.
  
  
   - Modelo 3:
  
  En promedio en cada pronostico se estima un error de +- 3.014298 puntos del indice de producci√≥n nominal seg√∫n el RMSE y de +- 2.33551 puntos del indice de producci√≥ nominal seg√∫n MAE, mientras que MAPE estima que en promedio cada pronostico se comete un error de +- 2.28% con relaci√≥n al valor real del indice de producci√≥n nominal, todo esto en el modelo de Filtro de decomposici√≥n combinado Loess cuadr√°tico.
  
  
   - Modelo 4:
  

  En promedio en cada pronostico se estima un error de +- 3.187973 puntos del indice de producci√≥n nominal seg√∫n el RMSE y de +- 2.670446 puntos del indice de producci√≥ nominal seg√∫n MAE, mientras que MAPE estima que en promedio cada pronostico se comete un error de +- 2.53% con relaci√≥n al valor real del indice de producci√≥n nominal, todo esto en el modelo de SEHW.
  
  
  
* Con base en la amplitud media y cobertura de los I.P ¬øqu√© se concluye?


(... Tablas de amplitud y cobertura en los modelos ...)


```{r}
#Creando funci√≥n usuario amplitud() para calcular la amplitud promedio de los I.P en pron√≥sticos ex ‚Äì post
amplitud=function(LIP,LSP){
a=LSP-LIP
am=mean(a)
am
}
#Creando funci√≥n usuario cobertura() para calcular la cobertura de los I.P en pron√≥sticos ex ‚Äì post
cobertura=function(real,LIP,LSP){
I=ifelse(real>=LIP & real<=LSP,1,0)
p=mean(I)
p
}
```


Modelo 1:

```{r}
amplitud(LIP=ytpron1[,2],LSP=ytpron1[,3])
cobertura(real=ytnuevo,LIP=ytpron1[,2],LSP=ytpron1[,3])
```


Modelo 2:


```{r}
amplitud(LIP=ytpron2[,2],LSP=ytpron2[,3])
cobertura(real=ytnuevo,LIP=ytpron2[,2],LSP=ytpron2[,3])
```

Modelo 4:

```{r}
#Precisi√≥n pron√≥sticos por I.P Holt-Winters

amplitud(LIP=pronos4[,3],LSP=pronos4[,2])
cobertura(real=ytnuevo,LIP=pronos4[,3],LSP=pronos4[,2])
```

Seg√∫n este criterio todos los modelos que tienen intervalo de predicci√≥n tienen una cubertura del 100%, es decir todos los valores reales caen en el intervalo.

El modelo 1 es el de menor amplitud, por lo tanto seg√∫n este criterio seria el mejor modelo.




* ¬øQu√© se concluye de la figura comparativa de los pron√≥sticos puntuales?


```{r}
plot(ytnuevo,lwd=2, col=1, type="b", pch=1, xlab="Periodo del a√±o")
lines(ytpron1[,1],lwd=2, col=2, type="b", pch=2)
lines(ytpron2[,1],lwd=2, col=3, type="b", pch=3)
lines(ytpron3,lwd=2,col=4, type="b", pch=4)
lines(ytpron4,lwd=2,col=5, type="b", pch=5)
legend("bottomright",legend=c("Real","Pronostico modelo1", "Pronostico modelo2", "Pronostico modelo3", "Pronostico modelo4"),col=1:5,lwd=2, pch=1:5, cex=0.8)
```

* En base a la gr√°fica de pronosticos se escoge como mejor modelo el modelo 3.


# 6. Conclusiones del trabajo: 

En esta secci√≥n debe presentar un resumen de los resultados encontrados en el respectivo trabajo, as√≠ como enunciar los problemas enfrentados en la modelaci√≥n, postular cu√°l ha sido el mejor modelo en ajuste y pron√≥stico entre los tratados y comentar acerca de lo que usted crea que logr√≥ este mejor modelo:

* ¬øCaptur√≥ la din√°mica de la serie?

* ¬øSu tendencia, estacionalidad y sus variaciones c√≠clicas son bien ajustadas?

* ¬øLos pron√≥sticos parecen realistas y confiables?

* ¬øQu√© otras alternativas podr√≠an haberse propuesto?

* ¬øCr√≠ticas al mejor modelo que encontr√≥ en el trabajo actual? 

* Exprese claramente qu√© recomienda para la serie en cuanto a ajustes globales o locales, seg√∫n lo realizado hasta el momento.

























