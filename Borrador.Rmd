---
title: "Borrador"
author: "Jennifer Salazar"
output: powerpoint_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Falta hacer esto

Defina la variable de la serie, su unidad de medida, su construcci칩n e interpretacion de sus cifras, per췂캼odos observados, frecuencia de observaci췂on, total de observaciones y fuente de los datos.



# Librerias utiles

```{r}
library(forecast)
library(TSA)
library(fANCOVA)
```



```{r}
Datos20
```


# 2. Analisis descriptivo de la serie y modelos propuestos:



```{r}
plot(Datos20)
```



## Descomposici칩n aditiva (tendencia)

* La serie es de componentes aditivas dado que su varianza es constante alrededor de su trayectoria de largo plazo(tendencia).


```{r}
Tt=decompose(Datos20)$trend
plot(Tt,ylim=c(min(Datos20),max(Datos20)))
```

* es visible que la serie es de tendencia creciente y que existen ciclos.


##  grafico de boxplots comparativos de la distribucion de la serie versus per캼odos del a침o calendario


```{r}
boxplot(Datos20~cycle(Datos20), names=month.abb)
grid()
```

* vemos c칩mo la media en particular la mediana de la distribuci칩n de la serie seg칰n periodo del a침o, cambia a lo largo de un a침o calendario siendo menor en los meses de enero, febrero, abril y diciembre comparados con el resto del a침o. Tiene un crecimiento de enero a marzo y luego vuelve y baja en abril  para volver a subir en mayo manteniendose relativamente al mismo nivel en los siguientes meses hasta noviembre, para luego decaer en diciembre y retormar el siguiente a침o.


## Periodograma


```{r}
periodogram(diff(Datos20),lwd=4) #periodograma sobre los logaritmos diferenciados
abline(v=c(1:6)/12,col=2,lty=2)
grid()
```


el periodograma muestra la asociacion de la serie con cuatro componentes periodicas (por valor alto del periodograma en esas frecuencias): en las frecuencias 1/12 y 2/12, 3/12, 4/12.


# justifique por que existe componente estacional y si su forma es constante o no en el tiempo. 

- Mediante el gr치fico de la serie vs el tiempo se ve un patr칩n que se repite cada a침o; pues en cada a침o se observa que en los meses del inicio y del final el 칤ndice de producci칩n nominal es bajo y tiene aproximadamente 2 picos de decaimiento en el transcurso del a침o.

- Dado que en el gr치fico de boxplot al menos una de las medias de los meses cambia respecto al resto de los meses del a침o calendario, por lo tanto se concluye que cada periodo en que se divide el a침o calendario determina una estaci칩n, la cual tiene incidencia sobre el valor medio de la serie, por ellos se dice que existe la componente estacional.

- Mediante el periodograma se resalta que hay una asociaci칩n de la serie con fenomenos periodicos, indicando la existencia de una componente estacional.


## Es la estacionalidad constante o no en el tiempo:

```{r}
par(mfrow=c(2,2))
plot(Datos20, xlim=c(2001,2005))
plot(Datos20, xlim=c(2006,2010))
plot(Datos20, xlim=c(2011,2015))
plot(Datos20, xlim=c(2016,2019))

```

Estamos en desacuerdo, lo respondemos m치s tarde.

## la tendencia se puede ajustar globalmente o si es local.

- La tendencia de la serie es global ya que se puede ajustar una curva suave creciente en todos los tiempos de la serie, Tambi칠n se puede ajustar modelos locales para comparar los ajustes y pronosticos respecto a la ajuste global.



##  identificacion de posibles ciclos y cambios estructurales.

* Hay presencia de ciclos en la serie a tr치ves del tiempo ya que al aplicar la descomposici칩n aditiva y obtener la tendencia, no se observa una curva suave que describa la tendencia de la serie.
* Hay aproximadamente entre 4 y 5 ciclos en la serie a trav칠s del tiempo (monta침as).
* No hay presencia de cambios estructurales en la serie.




#################################################################################


# Modelos propuestos




Por el an치lisis descriptivo, para los modelos globales la tendencia en escala logaritmo natural puede ser ajustada por un polinomio de grado $p = 2, 3$ y la componente estacional puede representarse como un factor y por tanto usar
variables indicadoras en los modelos globales. Se proponen los siguientes modelos de regresi칩n, donde t es el 칤ndice de tiempo y $I_{i,t}$ es la indicadora del trimestre i en el tiempo t.


## Modelo 1: Modelo cuadr치tico estacional con indicadoras, mes de referencia diciembre

$$Y_t=\beta_0+\beta_1t+\beta_2t^2+\sum_{i=1}^{12}\delta_iI_{i,t}+E_t, ~~~ E_t \sim iid N(0, \sigma^2)$$

## Modelo 2: Modelo c칰bico estacional con indicadoras, mes de referencia diciembre

$$Y_t=\beta_0+\beta_1t+\beta_2t^2+\beta_3t^3+\sum_{i=1}^{12}\delta_iI_{i,t}+E_t, ~~~ E_t \sim iid N(0, \sigma^2)$$

## Modelos 3: Descomposici칩n aditiva & Loess cuadr치tico

En la vecindad de un tiempo $t_k$ donde se quiere ajustar, $Y_t = \beta_{0,k} + \beta_{1,k}t + \beta_{2,k}t^2 + \sum_{i=1}^{12}\delta_i I_{i,t} +  E_t, ~~ E_t \sim iid N(0,\sigma^2)$ para todo t vecino a $t_k$, con $\sum_{i=1}^{12}\delta_i=0,~~~ \beta_{0,k},~\beta_{1,k}~y~\beta_{2,k}$ los parametros de la parabola local en la vecindad de $t_k$


## Modelo 4: Suavizamiento exponencial Holt-Winters aditivo

$Y_{t+h} = \beta_{0,t} + \beta_{1,t}\times h + \sum_{i=1}^{12}\delta_{i,t} I_{i,t+h} +  E_{t+h}, ~~ E_t \sim iid N(0,\sigma^2)$, con $\sum_{i=1}^{12}\delta_{i,t}=0,~~\beta_{0,t}~y~\beta_{1,t}~y~\delta_{i,t}$, el nivel en $t$, la pendiente en $t$ y los efectos estacionales en $t$, respectivamente, cambiando lentamente en el tiempo.




## Ajuste de los modelos con validaci칩n cruzada


```{r}
m <- 12 # numero de periodos a pronosticar dentro de la muestra
n <-length(Datos20)-m # tama침o de la muestra para el ajuste
t <- 1:n #Indice de tiempo en los periodos de ajuste
```


* Datos para el ajuste:

```{r}
yt <- ts(Datos20[t], frequency = 12, start=c(2001, 1))
```


* Definiendo factor para estacionalidad pero solo para la regresion lineal modelo 1

* Creaci칩n de las variables indicadoras para los datos de muestra
```{r}
mes <- seasonaldummy(yt) #Matriz con las 11 primeras variables Indicadoras mes


#Separando una a una las 11 variables indicadoras

I1 <- mes[,1]
I2 <- mes[,2]
I3 <- mes[,3]
I4 <- mes[,4]
I5 <- mes[,5]
I6 <- mes[,6]
I7 <- mes[,7]
I8 <- mes[,8]
I9 <- mes[,9]
I10 <- mes[,10]
I11 <- mes[,11]
```


* Creaci칩n de las variables indicadoras para los datos de validaci칩n cruzada


```{r}
tnuevo <- (n+1):length(Datos20)
ytnuevo <- ts(Datos20[tnuevo], frequency = 12, start = c(2019, 1))


mesnuevo <- seasonaldummy(yt, h=12)
#Separando una a una las 11 indicadoras para los tiempos de pron?stico
I1n=mesnuevo[,1]
I2n=mesnuevo[,2]
I3n=mesnuevo[,3]
I4n=mesnuevo[,4]
I5n=mesnuevo[,5]
I6n=mesnuevo[,6]
I7n=mesnuevo[,7]
I8n=mesnuevo[,8]
I9n=mesnuevo[,9]
I10n=mesnuevo[,10]
I11n=mesnuevo[,11]
```



## Ajuste del modelo 1 Modelo cuadr치tico estacional con indicadoras


```{r}
mod1 <- lm(yt~t+I(t^2)+I1+I2+I3+I4+I5+I6+I7+I8+I9+I10+I11)
summary(mod1)
```


## Ajuste del modelo 2 Modelo c칰bico estacional con indicadoras


```{r}
mod2 <- lm(yt~t+I(t^2)+I(t^3)+I1+I2+I3+I4+I5+I6+I7+I8+I9+I10+I11)
summary(mod2)
```


## Funciones a utilizar:

```{r}
#Creando funci칩n para extraer correctamente estimaciones de los efectos estacionales 洧럋洧눍 por filtro de descomposici칩n
factoresdeltai=function(descom,s,estacionini){
if(estacionini==1){
deltasi=descom$figure
}
if(estacionini!=1){
j=estacionini;deltasi=c(descom$figure[(s-j+2):s],descom$figure[1:(s-j+1)])
}
deltasi
}
```


## Ajuste modelo 3 Descomposici칩n aditiva & Loess cuadr치tico


```{r}
#Descomposici칩n aditiva de la serie recortada
descom=decompose(yt,type="additive")
```



```{r}
s=12 #Longitud del periodo estacional
```



```{r}
#Componente estacional estimada de la descomposici칩n de la serie recortada
St=descom$seasonal


deltas_i=factoresdeltai(descom=descom,s=12,estacionini=1) #Obteniendo los s factores estacionales estimados


#el per칤odo es s=12 y la serie arranca en estaci칩n 1
data.frame(deltas_i)
```



```{r}
#Pron칩sticos para la componente estacional usando estimaciones del filtro de descomposici칩n cl치sica

#los pron칩sticos inician en enero 2019 y terminan en diciembre 2019

i=c(1,2,3,4,5,6,7,8,9,10,11,12) #identificando la estaci칩n correspondiente a los m=12 per칤odos de pron칩sticos
```




```{r}
Stnuevo=deltas_i[i] #Asignando el valor de St a los per칤odos a pronosticar
Stnuevo=ts(Stnuevo,frequency=12,start=c(2019,1)) #convirtiendo en serie de tiempo al pron칩stico de St
Stnuevo
```

```{r}
#Desestacionalizando o ajustando estacionalmente a la serie recortada, seg칰n modelo aditivo
ytd=yt-St
```



```{r}
#LOESS cuadr치tico (AICC) sobre serie desestacionalizada
ajusteLoess2=loess.as(t,ytd,degree=2,criterion="aicc",family="gaussian",plot=F)
summary(ajusteLoess2)
alfa.optim2=ajusteLoess2$pars$span #guardando el valor 칩ptimo del par치metro alfa
```




## Ajuste modelo 4 con m칠todo Suavizamiento exponencial Holt-Winters aditivo

### Modelo de tendencia con cambio de nivel y pendiente, aditiva a factor estacional con efectos que evolucionan lentamente en el tiempo

```{r}
suav=HoltWinters(yt,seasonal="additive") #Suavizamiento con valores 칩ptimos en par치metros 洧럈, 洧량, 洧럊
suav
```


# Valores ajustados de los modelos 


Modelo 1

```{r}
mod1_ajust <- fitted(mod1)
```


```{r}
plot(Datos20)
lines(mod1_ajust, col=2, lwd=2)
legend("topleft", legend = c("Original", "Ajuste del modelo1"), lty=1, col=c(1,2))

```




